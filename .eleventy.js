const fs = require("fs");
const path = require("path");
const Image = require("@11ty/eleventy-img");

const manifestPath = path.resolve(
	__dirname,
	"public",
	"assets",
	"manifest.json"
);
const manifest = JSON.parse(
	fs.readFileSync(manifestPath, { encoding: "utf8" })
);

module.exports = function (eleventyConfig) {
	// use shortcodes {% webpackAsset 'main.js' %} or {% webpackAsset 'main.css' %}
	eleventyConfig.addShortcode("webpackAsset", function (name) {
		if (!manifest[name]) {
			throw new Error(
				`The asset ${name} does not exist in ${manifestPath}`
			);
		}
		return manifest[name];
	});

	// shortcode for responsive images
	eleventyConfig.addShortcode(
		"image",
		async function (src, alt = "", sizes = "100vw") {
			try {
				let metadata = await Image(src, {
					widths: [300, 1000],
					formats: ["webp", "jpeg"],
					urlPath: "/assets/images/",
					outputDir: "./public/assets/images",
				});

				let lowsrc = metadata.jpeg[0];

				return `<picture>
		  ${Object.values(metadata)
				.map((imageFormat) => {
					return `  <source type="image/${
						imageFormat[0].format
					}" srcset="${imageFormat
						.map((entry) => entry.srcset)
						.join(", ")}" sizes="${sizes}">`;
				})
				.join("\n")}
			<img
			  src="${lowsrc.url}"
			  alt="${alt}">
		  </picture>`;
			} catch (err) {
				return `<img
			src="data:image/svg+xml,%3Csvg width='100' height='40' viewBox='0 0 100 40' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='40' fill='%23EEEEEE'/%3E%3Cpath d='M48.7934 19.7651C48.8376 19.7709 48.8823 19.7588 48.9176 19.7317C48.9529 19.7045 48.976 19.6644 48.9817 19.6201C48.9875 19.5759 48.9754 19.5313 48.9482 19.496C48.921 19.4606 48.8809 19.4376 48.8367 19.4318L48.5434 19.3585C48.522 19.3519 48.4995 19.3497 48.4773 19.3521C48.455 19.3544 48.4335 19.3611 48.4139 19.372C48.3943 19.3828 48.3771 19.3974 48.3633 19.4151C48.3495 19.4327 48.3394 19.4529 48.3336 19.4745C48.3278 19.4961 48.3264 19.5186 48.3295 19.5408C48.3325 19.5629 48.3401 19.5842 48.3515 19.6034C48.363 19.6226 48.3783 19.6393 48.3963 19.6525C48.4144 19.6657 48.4349 19.6751 48.4567 19.6801L48.7501 19.7585C48.764 19.7631 48.7787 19.7654 48.7934 19.7651V19.7651ZM49.4367 18.8335C49.4465 18.8698 49.4683 18.9018 49.4986 18.9242C49.5288 18.9466 49.5658 18.9581 49.6034 18.9568C49.6177 18.9591 49.6324 18.9591 49.6467 18.9568C49.689 18.9451 49.725 18.9172 49.7469 18.8791C49.7687 18.8411 49.7746 18.7959 49.7634 18.7535L49.6851 18.4601C49.68 18.4384 49.6706 18.4178 49.6574 18.3998C49.6442 18.3817 49.6275 18.3664 49.6083 18.355C49.5891 18.3435 49.5678 18.336 49.5457 18.3329C49.5235 18.3298 49.501 18.3312 49.4794 18.337C49.4578 18.3429 49.4376 18.353 49.42 18.3668C49.4024 18.3805 49.3877 18.3977 49.3769 18.4173C49.3661 18.4369 49.3593 18.4584 49.357 18.4807C49.3547 18.5029 49.3568 18.5254 49.3634 18.5468L49.4367 18.8335ZM50.2417 20.5001C50.2262 20.4838 50.2074 20.4707 50.1866 20.4618C50.1659 20.4529 50.1435 20.4483 50.1209 20.4483C50.0983 20.4483 50.0759 20.4529 50.0551 20.4618C50.0344 20.4707 50.0156 20.4838 50.0001 20.5001L49.4167 21.0935C49.3481 21.1593 49.2568 21.196 49.1617 21.196C49.0667 21.196 48.9753 21.1593 48.9067 21.0935C48.873 21.0601 48.8462 21.0204 48.8279 20.9767C48.8096 20.9329 48.8001 20.8859 48.8001 20.8385C48.8001 20.791 48.8096 20.7441 48.8279 20.7003C48.8462 20.6565 48.873 20.6168 48.9067 20.5835L49.5001 20.0001C49.5175 19.9852 49.5317 19.9668 49.5417 19.9461C49.5517 19.9255 49.5573 19.9029 49.5582 19.88C49.5591 19.857 49.5552 19.8341 49.5468 19.8128C49.5385 19.7914 49.5257 19.7719 49.5095 19.7557C49.4933 19.7395 49.4738 19.7268 49.4525 19.7184C49.4311 19.71 49.4082 19.7061 49.3852 19.707C49.3623 19.7079 49.3397 19.7135 49.3191 19.7235C49.2984 19.7335 49.28 19.7477 49.2651 19.7651L48.6667 20.3468C48.6019 20.4116 48.5506 20.4885 48.5155 20.5732C48.4804 20.6578 48.4624 20.7485 48.4624 20.8401C48.4624 20.9318 48.4804 21.0225 48.5155 21.1071C48.5506 21.1918 48.6019 21.2687 48.6667 21.3335C48.7315 21.3983 48.8084 21.4497 48.8931 21.4847C48.9777 21.5198 49.0684 21.5378 49.1601 21.5378C49.2517 21.5378 49.3424 21.5198 49.4271 21.4847C49.5117 21.4497 49.5886 21.3983 49.6534 21.3335L50.2417 20.7451C50.2586 20.7295 50.2721 20.7106 50.2814 20.6895C50.2906 20.6684 50.2954 20.6457 50.2954 20.6226C50.2954 20.5996 50.2906 20.5769 50.2814 20.5558C50.2721 20.5347 50.2586 20.5158 50.2417 20.5001V20.5001ZM48.8634 19.0985C48.8944 19.1293 48.9363 19.1466 48.9801 19.1468C49.002 19.1469 49.0237 19.1427 49.044 19.1344C49.0644 19.1261 49.0828 19.1139 49.0984 19.0985C49.1294 19.0673 49.1469 19.025 49.1469 18.981C49.1469 18.937 49.1294 18.8947 49.0984 18.8635L48.8834 18.6485C48.8515 18.6212 48.8105 18.6069 48.7686 18.6085C48.7266 18.6102 48.6868 18.6275 48.6571 18.6572C48.6275 18.6869 48.6101 18.7267 48.6084 18.7686C48.6068 18.8106 48.6211 18.8516 48.6484 18.8835L48.8634 19.0985ZM51.5434 20.3201L51.2501 20.2418C51.2283 20.2343 51.2053 20.2314 51.1823 20.2332C51.1594 20.235 51.1371 20.2416 51.1168 20.2525C51.0966 20.2633 51.0788 20.2783 51.0646 20.2964C51.0504 20.3144 51.04 20.3353 51.0343 20.3575C51.0285 20.3798 51.0274 20.403 51.0311 20.4257C51.0347 20.4484 51.043 20.4701 51.0554 20.4895C51.0679 20.5088 51.0842 20.5254 51.1033 20.5381C51.1225 20.5509 51.1441 20.5595 51.1667 20.5635L51.4601 20.6418H51.5034C51.5476 20.6476 51.5923 20.6355 51.6276 20.6083C51.6629 20.5811 51.686 20.541 51.6917 20.4968C51.6975 20.4526 51.6854 20.4079 51.6582 20.3726C51.631 20.3373 51.5909 20.3142 51.5467 20.3085L51.5434 20.3201ZM50.5634 21.1668C50.5576 21.1457 50.5477 21.1259 50.5343 21.1086C50.5208 21.0913 50.5041 21.0768 50.4851 21.066C50.466 21.0551 50.4451 21.0482 50.4233 21.0455C50.4016 21.0427 50.3795 21.0443 50.3584 21.0501C50.3161 21.0619 50.2801 21.0898 50.2583 21.1278C50.2364 21.1659 50.2305 21.2111 50.2417 21.2535L50.3201 21.5468C50.3298 21.5832 50.3516 21.6152 50.3819 21.6376C50.4121 21.6599 50.4491 21.6714 50.4867 21.6701C50.5011 21.6718 50.5157 21.6718 50.5301 21.6701C50.5513 21.6645 50.5713 21.6548 50.5888 21.6414C50.6063 21.6281 50.6209 21.6114 50.6319 21.5923C50.6429 21.5732 50.6501 21.5522 50.6529 21.5304C50.6557 21.5085 50.6542 21.4864 50.6484 21.4651L50.5634 21.1668ZM51.1367 20.9051C51.1048 20.8778 51.0638 20.8636 51.0219 20.8652C50.9799 20.8668 50.9402 20.8842 50.9105 20.9139C50.8808 20.9436 50.8634 20.9834 50.8618 21.0253C50.8602 21.0673 50.8744 21.1083 50.9017 21.1401L51.1167 21.3551C51.148 21.3862 51.1902 21.4036 51.2342 21.4036C51.2783 21.4036 51.3205 21.3862 51.3517 21.3551C51.3828 21.3239 51.4002 21.2817 51.4002 21.2376C51.4002 21.1936 51.3828 21.1514 51.3517 21.1201L51.1367 20.9051ZM51.5334 19.1668C51.536 19.0282 51.497 18.892 51.4214 18.7758C51.3458 18.6596 51.2371 18.5688 51.1094 18.5149C50.9817 18.4611 50.8407 18.4468 50.7048 18.4739C50.5688 18.501 50.4441 18.5682 50.3467 18.6668L49.7584 19.2601C49.7426 19.276 49.7302 19.2948 49.7217 19.3155C49.7132 19.3362 49.7089 19.3584 49.7089 19.3807C49.709 19.4031 49.7135 19.4252 49.7221 19.4459C49.7308 19.4665 49.7434 19.4852 49.7592 19.501C49.7751 19.5167 49.7939 19.5292 49.8146 19.5377C49.8353 19.5462 49.8575 19.5505 49.8798 19.5504C49.9022 19.5504 49.9243 19.5459 49.9449 19.5373C49.9656 19.5286 49.9843 19.516 50.0001 19.5001L50.5834 18.9068C50.652 18.841 50.7434 18.8043 50.8384 18.8043C50.9334 18.8043 51.0248 18.841 51.0934 18.9068C51.1272 18.9401 51.154 18.9799 51.1723 19.0236C51.1906 19.0674 51.2 19.1144 51.2 19.1618C51.2 19.2093 51.1906 19.2562 51.1723 19.3C51.154 19.3438 51.1272 19.3835 51.0934 19.4168L50.5001 20.0001C50.469 20.0314 50.4516 20.0736 50.4516 20.1176C50.4516 20.1617 50.469 20.2039 50.5001 20.2351C50.5313 20.2662 50.5735 20.2836 50.6176 20.2836C50.6616 20.2836 50.7038 20.2662 50.7351 20.2351L51.3334 19.6535C51.461 19.5235 51.5327 19.3489 51.5334 19.1668V19.1668Z' fill='%23CCCCCC'/%3E%3C/svg%3E"
			alt="${alt}">`;
			}
		}
	);

	// Copy all images directly to dist.
	eleventyConfig.addPassthroughCopy({ assets: "assets" });
	eleventyConfig.setBrowserSyncConfig({ files: [manifestPath] });

	return {
		dir: {
			input: ".",
			data: "_data",
			includes: "_includes", // relative to dir.input
			layouts: "_layouts",
			output: "public",
		},
		htmlTemplateEngine: "liquid",
		passthroughFileCopy: true,
	};
};
